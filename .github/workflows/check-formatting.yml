name: check-build-and-formatting

on:
  pull_request:

jobs:
  check-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (for forks and branches)
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Create backend .env file
        run: |
          cp backend/.env.example backend/.env

      - name: Install backend dependencies
        run: |
          cd backend &&
          pip install . &&
          pip install black ruff pyright &&
          prisma generate

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install frontend dependencies
        run: |
          cd frontend &&
          bun install

      - name: black
        run: |
          cd backend &&
          black . --check

      - name: ruff
        run: |
          cd backend &&
          ruff check .

      - name: pyright
        run: |
          cd backend &&
          pyright .

      - name: prettier
        run: |
          cd frontend &&
          bun run prettier . --check

      - name: frontend-build
        run: |
          cd frontend &&
          CI=True bun run build

      - name: Start database for schema generation
        run: |
          cd backend &&
          docker compose up -d &&
          sleep 5

      - name: Generate OpenAPI schema
        run: |
          cd backend &&
          python generate_openapi.py

      - name: Generate frontend API client
        run: |
          cd frontend &&
          bun run openapi -i ../backend/openapi.json -o src/api &&
          bun run prettier --write src/api

      - name: Check for schema differences
        run: |
          API_CHANGES=$(git diff --name-only | grep '^frontend/src/api/' || true)
          
          if [ -z "$API_CHANGES" ]; then
            echo "✓ Frontend API client is up to date"
            exit 0
          fi
          
          # Allow only Page.ts with props change
          if [ "$API_CHANGES" = "frontend/src/api/models/Page.ts" ]; then
            if git diff -- frontend/src/api/models/Page.ts | grep -q 'props.*:'; then
              CHANGE_COUNT=$(git diff --numstat -- frontend/src/api/models/Page.ts | awk '{print $1 + $2}')
              if [ "$CHANGE_COUNT" -eq 2 ]; then
                echo "✓ Only expected Page.ts props change (see README)"
                exit 0
              fi
            fi
          fi
          
          echo "✗ Frontend API client out of sync"
          echo "See README for regeneration steps"
          git diff --stat | grep 'frontend/src/api/'
          exit 1
